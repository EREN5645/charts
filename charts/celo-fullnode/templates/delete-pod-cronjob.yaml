{{- if .Values.deletePodCronJob.enabled -}}
{{- /*
This CronJob in intended to delete regularly a geth pod
in order to force geth to flush the data to disk, so it can 
be used as an snapshot
*/}}
apiVersion: batch/v1
kind: CronJob
metadata:
  labels:
    {{- include "common.standard.labels" . | nindent 4 }}
    component: restart-geth
  name: {{ template "common.fullname" . }}-restart-geth
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        metadata:
          labels:
            {{- include "common.standard.labels" . | nindent 12 }}
            component: restart-geth
        spec:
          containers:
          - name: restart-geth
            command:
            - /bin/sh
            - -c
            args:
            - |
              extraFlags="{{ .Values.deletePodCronJob.extraFlags }}"
              kubectl delete pod -n {{ .Release.Namespace }} "${extraFlags}" {{ printf "%s-%d" (include "common.fullname" .) (.Values.deletePodCronJob.podIndex | int) }}
            image: bitnami/kubectl:latest
            imagePullPolicy: Always
            terminationMessagePath: /dev/termination-log
            terminationMessagePolicy: File
          dnsPolicy: ClusterFirst
          restartPolicy: Never
          schedulerName: default-scheduler
          serviceAccountName: {{ template "common.fullname" . }}-restart-geth
          terminationGracePeriodSeconds: 30
  schedule: "{{ .Values.deletePodCronJob.schedule }}"
  successfulJobsHistoryLimit: 3
  suspend: false
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    {{- include "common.standard.labels" . | nindent 4 }}
    component: restart-geth
  name: {{ template "common.fullname" . }}-restart-geth
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    {{- include "common.standard.labels" . | nindent 4 }}
    component: restart-geth
  name: {{ template "common.fullname" . }}-restart-geth
rules:
- apiGroups:
  - ""
  resources:
  - namespaces
  verbs:
  - get
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
  - watch
  - delete
  - update
  - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    {{- include "common.standard.labels" . | nindent 4 }}
    component: restart-geth
  name: {{ template "common.fullname" . }}-restart-geth
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ template "common.fullname" . }}-restart-geth
subjects:
- kind: ServiceAccount
  name: {{ template "common.fullname" . }}-restart-geth
  namespace: {{ .Release.Namespace }}
{{- end }}
